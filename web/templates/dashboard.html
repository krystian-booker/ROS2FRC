{% extends "layout.html" %}

{% block content %}
<h1>FRC VisionTools</h1>
<div id="status" class="status mb-3">Connectingâ€¦</div>

<div id="camera-topics" class="mt-3">
    <h2>Available Camera Topics</h2>
    <ul id="topic-list"></ul>
</div>

<div id="camera-feed" class="mt-4">
    <h2>Camera Feed</h2>
    <img id="camera-img" width="640" height="480" style="border:1px solid #ccc;" />
</div>

<script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>

<script>
    const ros = new ROSLIB.Ros({ url: 'ws://{{ localIP }}:9090' });
    const statusEl = document.getElementById('status');
    const topicListEl = document.getElementById('topic-list');
    const cameraImgEl = document.getElementById('camera-img');

    ros.on('connection', () => {
        statusEl.textContent = 'ðŸŸ¢ Connected to ROS!';
        statusEl.className = 'status connected mb-3';

        ros.getTopics((topics) => {
            const matchingTopics = topics.topics.filter(topic =>
                topic.startsWith('/camera/') && topic.endsWith('/image_raw')
            );

            if (matchingTopics.length === 0) {
                topicListEl.innerHTML = '<li>No matching topics found.</li>';
            } else {
                matchingTopics.forEach(topic => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = topic;
                    link.onclick = () => startStream(topic);
                    li.appendChild(link);
                    topicListEl.appendChild(li);
                });

                startStream(matchingTopics[0]);
            }
        });
    });

    function startStream(topicName) {
        cameraImgEl.src = `http://{{ localIP }}:8080/stream?topic=${topicName}`;
    }

    ros.on('error', () => {
        statusEl.textContent = 'ðŸ”´ Connection error';
        statusEl.className = 'status error mb-3';
    });

    ros.on('close', () => {
        statusEl.textContent = 'âšª Connection closed';
        statusEl.className = 'status closed mb-3';
    });
</script>
{% endblock %}